# 压测



## 创建用户

在`client-tools`项目中使用命令`createlist 5000`创建 5000 个用户备用

```shell
$ git clone git@gitlab.33.cn:chat/client-tools.git
$ cd client-tools/cmd/
$ go build -o main
$ main createlist 5000
```



## 压测策略

> cli pm -n=n -m=m

模拟私聊行为, `n` 个用户同时在线, 每隔`1`秒随机向另一个人发送一条信息, 每人发 `m` 条

总共 `n*m` 条信息



> cli gc -n=n -m=m

模拟群聊行为, `n` 个用户同时在线, 并在一个群里, 每人每隔`1`秒发一条信息, 即同时向群里其他所有人发一条信息, 每人发` m` 条

总共 `n*(n-1)*m`条信息


> cli clean -n=n

n 个用户登录，不发消息，只接收消息



## 快速开始

```shell
$ git clone git@gitlab.33.cn:chat/im-util.git
$ cd im-util/client-pressure/cmd/cli
$ go build -o cli
# 使用前需要把 DB.txt 放到 db 文件夹中
$ cli -h
# $ cli -mode=pm -n=1000 -m=3
# $ cli -mode=gc -n=100 -m=3
```



## 日志分析

```shell
$ cd im-util/client-pressure/
$ mv cmd/cli/log analyse/
$ cd analyse/
$ go run .
```

## 日志格式说明
- ChatError_xxx.log
  记录各种 error log 信息

- ChatSend_xxx.log

  [msg 发送的时间]

> 2021-04-09T11:41:00.688997+08:00
2021-04-09T11:41:01.694273+08:00
2021-04-09T11:41:00.778318+08:00
2021-04-09T11:41:01.783268+08:00

- ChatSendReply_xxx.log

  [LogId] [msgReply收到的时间]

> 113241429416873984 2021-04-09T11:41:00.722777+08:00
113241433657315328 2021-04-09T11:41:01.735426+08:00
113241429794361344 2021-04-09T11:41:00.847353+08:00
113241434005442560 2021-04-09T11:41:01.846837+08:00

- ChatReceive_xxx.log

  [LogId] [msg发送的时间] [msg 收到的时间]

> 113241429794361344 2021-04-09T11:41:00.778318+08:00 2021-04-09T11:41:00.847422+08:00
113241434005442560 2021-04-09T11:41:01.783268+08:00 2021-04-09T11:41:01.846837+08:00
113241429416873984 2021-04-09T11:41:00.688997+08:00 2021-04-09T11:41:00.741393+08:00
113241433657315328 2021-04-09T11:41:01.694273+08:00 2021-04-09T11:41:01.743172+08:00

